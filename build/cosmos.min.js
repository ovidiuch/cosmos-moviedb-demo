var Cosmos=function(t){var e=Cosmos.getComponentByName(t.component);if(!e)throw new Error("Invalid component: "+t.component);return e(_.clone(t))};if("undefined"!=typeof module&&module.exports){var React=require("react"),_=require("underscore"),$=require("jquery"),Play=require("play-js").Play;module.exports=Cosmos}_.extend(Cosmos,{mixins:{},components:{},transitions:{},start:function(t){return new this.Router(t)},render:function(t,e,n){var o=this(t);return e?React.renderComponent(o,e,n):React.renderComponentToString(o)},getComponentByName:function(t){return this.components[t]}}),Cosmos.RouterHistory=function(){},_.extend(Cosmos.RouterHistory,{transitionTypes:{NOOP:0,INITIAL:1,NEW:2,BACK:3,FORWARD:4},prototype:_.extend([],{_push:Array.prototype.push,push:function(t){if(t.queryString=Cosmos.serialize.getQueryStringFromProps(t.props),!this.length)return this.index=0,this._push(t),Cosmos.RouterHistory.transitionTypes.INITIAL;var e=this[this.index],n=this[this.index-1]||{},o=this[this.index+1]||{};return t.queryString==e.queryString?Cosmos.RouterHistory.transitionTypes.NOOP:t.queryString==n.queryString?(this.index--,Cosmos.RouterHistory.transitionTypes.BACK):(this.index++,t.queryString==o.queryString?(this._mergeEntryMataData(this[this.index],t),Cosmos.RouterHistory.transitionTypes.FORWARD):(this.splice(this.index,this.length-this.index),this._push(t),Cosmos.RouterHistory.transitionTypes.NEW))},canReusePropsInHistory:function(t){if(!this.length)return!1;var e=Cosmos.serialize.getQueryStringFromProps(t),n=this[this.index],o=this[this.index-1]||{},s=this[this.index+1]||{};return e==n.queryString||e==o.queryString||e==s.queryString},_mergeEntryMataData:function(t,e){for(var n in e)"queryString"!=n&&"props"!=n&&(t[n]=e[n])}})}),Cosmos.Router=function(t){this.options=_.extend({props:Cosmos.url.getParams(),container:document.body,transition:null},t),_.isEmpty(this.options.props)&&this.options.defaultProps&&(this.options.props=this.options.defaultProps),this.container=this.options.container,this._onPopState=this._onPopState.bind(this),this._bindPopStateEvent(),this._replaceInitialState(this.options.props),this._resetHistory(),this._loadEntry({props:this.options.props})},_.extend(Cosmos.Router,{CONTAINER_CLASS:"cosmos-component-container",prototype:{stop:function(){this._unbindPopStateEvent()},goTo:function(t,e){if(!Cosmos.url.isPushStateSupported())return void(window.location=t);var n=t.split("?").pop(),o=Cosmos.serialize.getPropsFromQueryString(n);this._pushHistoryState(o,t),this._loadEntry({props:o,originBounds:e})},_bindPopStateEvent:function(){window.addEventListener("popstate",this._onPopState)},_unbindPopStateEvent:function(){window.removeEventListener("popstate",this._onPopState)},_onPopState:function(t){t.state&&(this.history.length&&!this.history.canReusePropsInHistory(t.state)&&this._resetHistory(),this._loadEntry({props:t.state}))},_replaceInitialState:function(t){this._replaceHistoryState(t,window.location.href)},_resetHistory:function(){this.history=new Cosmos.RouterHistory,this._currentComponent=null,this._resetContainer()},_loadEntry:function(t){this._currentComponent&&(this.history[this.history.index].props=this._currentComponent.generateSnapshot());var e=this.history.push(t);if(e!=Cosmos.RouterHistory.transitionTypes.NOOP){t=this.history[this.history.index];var n=this.options.transition?this._createComponentContainer(t.queryString):this.container;this._currentComponent=Cosmos.render(t.props,n,function(){$(this.container).append(n),this._transitionComponentContainer(n,e)}.bind(this))}},_transitionComponentContainer:function(t,e){this.options.transition&&new this.options.transition({prevContainer:$(t).prev().get(0),nextContainer:t,history:this.history,transitionType:e})},_resetContainer:function(){$(this.container).empty()},_createComponentContainer:function(t){return $container=$('<div class="'+Cosmos.Router.CONTAINER_CLASS+'"></div>'),$container.get(0)},_replaceHistoryState:function(t,e){window.history.replaceState(t,"",e)},_pushHistoryState:function(t,e){window.history.pushState(t,"",e)}}}),Cosmos.serialize={getPropsFromQueryString:function(t){var e={};if(t.length)for(var n,o,s,i=t.split("&"),r=0;r<i.length;r++){n=i[r].split("="),o=n[0],s=decodeURIComponent(n[1]);try{s=JSON.parse(s)}catch(a){}e[o]=s}return e},getQueryStringFromProps:function(t){var e,n=[];for(var o in t){if(e=t[o],"object"==typeof e)try{e=JSON.stringify(e)}catch(s){continue}n.push(o+"="+encodeURIComponent(e))}return n.join("&")}},Cosmos.url={getParams:function(){return Cosmos.serialize.getPropsFromQueryString(window.location.search.substr(1))},isPushStateSupported:function(){return!!window.history.pushState}},Cosmos.transitions.Zoom=function(t){if(t.transitionType!=Cosmos.RouterHistory.transitionTypes.INITIAL){var e=$(t.prevContainer),n=$(t.nextContainer),o=n.parent(),s={width:o.width(),height:o.height()},i=this._getOriginBoundsForTransition(t.transitionType,t.history),r=this._getTransitionAnchors(s,i,t.transitionType);t.transitionType==Cosmos.RouterHistory.transitionTypes.BACK&&e.css("z-index",2),Play.start({id:this,time:.5,onFrame:function(o){var i=this._getPositionAndScaleInTransition(s,r,t.transitionType,o);e.css(i.prev),n.css(i.next),t.transitionType==Cosmos.RouterHistory.transitionTypes.BACK?(e.css("opacity",1-o),n.css("opacity",1)):(e.css("opacity",1),n.css("opacity",o)),1==o&&(React.unmountComponentAtNode(t.prevContainer),e.remove())}.bind(this)})}},Cosmos.transitions.Zoom.prototype={_getOriginBoundsForTransition:function(t,e){var n=t==Cosmos.RouterHistory.transitionTypes.BACK?e.index+1:e.index;return e[n].originBounds},_getTransitionAnchors:function(t,e){var n=e.width/t.width,o=1/n;return{fullScreen:{scale:1,x:0,y:0},awayFromScreen:{scale:n,x:-e.x,y:-e.y},inFrontOfScreen:{scale:o,x:e.x,y:e.y}}},_getPositionAndScaleInTransition:function(t,e,n,o){return n==Cosmos.RouterHistory.transitionTypes.BACK?{prev:this._translateRectPositionAndScale(t,e.awayFromScreen,e.fullScreen,1-o),next:this._translateRectPositionAndScale(t,e.fullScreen,e.inFrontOfScreen,1-o)}:{prev:this._translateRectPositionAndScale(t,e.fullScreen,e.inFrontOfScreen,o),next:this._translateRectPositionAndScale(t,e.awayFromScreen,e.fullScreen,o)}},_translateRectPositionAndScale:function(t,e,n,o){var s=n.scale-e.scale,i=e.scale+s*o,r=n.scale/i,a={x:n.x-e.x,y:n.y-e.y},p={x:e.x+a.x*o,y:e.y+a.y*o},h={scale:i,x:t.width/2,y:t.height/2};return h.x-=t.width/2/i,h.y-=t.height/2/i,h.x-=p.x*r,h.y-=p.y*r,h}},Cosmos.mixins.ClassName={getClassName:function(){var t=[];return this.defaultClass&&t.push(this.defaultClass),this.props["class"]&&t.push(this.props["class"]),t.length?t.join(" "):null}},Cosmos.mixins.DataFetch={fetchDataFromServer:function(t,e){var n=$.ajax({url:t,dataType:"json",complete:function(){this.xhrRequests=_.without(this.xhrRequests,n)}.bind(this),success:e,error:function(e,n,o){console.error(t,n,o.toString())}.bind(this)});this.xhrRequests.push(n)},receiveDataFromServer:function(t){this.setState({data:t})},getInitialData:function(){return void 0!==this.initialData?this.initialData:{}},resetData:function(t){this.setState({data:this.getInitialData()}),this.clearDataRequests(),t.dataUrl&&(this.fetchDataFromServer(t.dataUrl,this.receiveDataFromServer),t.pollInterval&&(this.pollInterval=setInterval(function(){this.fetchDataFromServer(t.dataUrl,this.receiveDataFromServer)}.bind(this),t.pollInterval)))},clearDataRequests:function(){for(;!_.isEmpty(this.xhrRequests);)this.xhrRequests.pop().abort();this.pollInterval&&clearInterval(this.pollInterval)},getDefaultProps:function(){return{pollInterval:0}},componentWillMount:function(){this.xhrRequests=[],this.resetData(this.props)},componentWillReceiveProps:function(t){t.dataUrl!=this.props.dataUrl&&this.resetData(t)},componentWillUnmount:function(){this.clearDataRequests()}},Cosmos.mixins.PersistState={generateSnapshot:function(){var t,e,n=this.getDefaultProps?this.getDefaultProps():{},o={};for(var s in this.props)t=this.props[s],"__owner__"!=s&&"state"!=s&&(n.hasOwnProperty(s)&&n[s]==t||(o[s]=t));return e=_.clone(this.state),_.isEmpty(e)||(o.state=e),o},componentWillMount:function(){this.props.state&&this.replaceState(this.props.state)},componentWillReceiveProps:function(t){t.state&&this.replaceState(t.state)}},Cosmos.mixins.Url={getUrlFromProps:function(t){return"?"+Cosmos.serialize.getQueryStringFromProps(t)},routeLink:function(t){t.preventDefault();var e=t.currentTarget;App.router.goTo($(e).attr("href"),this._getOriginBounds(e))},_getOriginBounds:function(t){var e=$(this.getDOMNode()),n=e.closest("."+Cosmos.Router.CONTAINER_CLASS),o=e.offset(),s=n.offset();return s&&(o.left-=s.left,o.top-=s.top),{width:e.outerWidth(),height:e.outerHeight(),x:o.left,y:o.top}}},Cosmos.components.List=React.createClass({mixins:[Cosmos.mixins.ClassName,Cosmos.mixins.DataFetch,Cosmos.mixins.PersistState],defaultClass:"list",initialData:[],render:function(){return React.DOM.ul({className:this.getClassName()},this.state.data.map(function(t,e){var n=Cosmos.getComponentByName(this._getComponentClassForItem(t));return React.DOM.li({key:e},n(_.clone(t)))}.bind(this)))},_getComponentClassForItem:function(t){return t.component||this.props.itemComponent||"Item"}});